<!-- <py-index> --><!-- <py-main> --><html lang="en">
    <head>
        <meta charset="utf-8"></meta>
        <link rel="stylesheet" href="/styles.css"></link>
        <link rel="stylesheet" href="/code.css"></link>
        <link rel="preconnect" href="https://fonts.googleapis.com"></link>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""></link>
        <link href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,200;0,400;0,700;1,400&display=swap" rel="stylesheet"></link> 
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no; target-densityDpi=device-dpi"></meta>
        <link rel="shortcut icon" href="/favicon.ico" sizes="32x32"></link>
        <title>smartcard - HakierGrzonzo</title>
        <meta name="robots" content="index, follow"></meta>
        <meta property="og:locale" content="en_US"></meta>
        <meta property="og:type" content="article"></meta>
        <meta property="og:title" content="smartcard - HakierGrzonzo"></meta>
        <meta property="og:description" content="HakierGrzonzo's Personal Website"></meta>
        <meta property="og:site_name" content="Grzegorz Koperwas Blog"></meta>
        <meta property="og:image" content="https://www.grzegorzkoperwas.site/hakiergrzonzo.png"></meta>
        <meta property="og:image:secure_url" content="https://www.grzegorzkoperwas.site/hakiergrzonzo.png"></meta>
    </head>
    <body>
        <nav>
            <div class="nav-container">
                <a href="/">Index</a>
                <a href="/projects.html">Projects</a>
                <a href="/about.html">About</a>
                <a href="/blog.html">Blog</a>
            </div>
        </nav>
        <div class="container">
            <!-- <py-article> --><div class="section">
    <h1>How to use SmartCards on Linux</h1>
<p>Smartcard are great for use with GnuPG keys and for two factor authentication.</p>
<h2>What smartcard should I buy?</h2>
<p>If you intend to use your smartcard to store your private GNU PG keys, you need
to get a card compatible with <em>OpenPGP-Standard</em>. Normal ones do not come with 
circuitry required for encryption and signing.</p>
<p>It is harder to find them then 
normal smartcards (and more expensive!), but I bought mine from 
<a href="https://www.floss-shop.de/en/security-privacy/smartcards/13/openpgp-smart-card-v3.4">FLOSS Shop</a>.
They do not accept credit cards, so you will have to pay by bank transfer.</p>
<h2>Which reader should I get?</h2>
<p>If your reader is supported by Linux, it should just work. As far as I know there
are no special requirements for OpenPGP cards.</p>
<h3>Installing for Arch Linux</h3>
<p>Follow the instructions in <a href="https://wiki.archlinux.org/title/Smartcards">Arch Wiki</a>.</p>
<p>If you are unsure that a reader that you own (e.g. One in your laptop) works
properly under Linux, you can test it by installing <code>pcsc-tools</code> package in Arch
Linux. Then run the following command:</p>
<div class="codehilite"><pre><span></span><code>$ pcsc_scan
Using reader plug<span class="err">&#39;</span>n play mechanism
Scanning present readers...
<span class="m">0</span>: Alcor Micro AU9540 <span class="m">00</span> <span class="m">00</span>

Thu Nov <span class="m">18</span> <span class="m">22</span>:32:40 <span class="m">2021</span>
 Reader <span class="m">0</span>: Alcor Micro AU9540 <span class="m">00</span> <span class="m">00</span>
  Event number: <span class="m">0</span>
  Card state: Card removed,
</code></pre></div>

<p>Then, you can test your reader with a smartcard you already own. A credit card will
work, but you can try whatever card you have access to.</p>
<div class="codehilite"><pre><span></span><code>Thu Nov 18 22:35:27 2021
 Reader 0: Alcor Micro AU9540 00 00
  Event number: 1
  Card state: Card inserted,
  ATR: 3B DA 18 FF 81 B1 FE 75 1F 03 00 31 F5 73 C0 01 60 00 90 00 1C
[...] // lots of info
Possibly identified card (using /usr/share/pcsc/smartcard_list.txt):
3B DA 18 FF 81 B1 FE 75 1F 03 00 31 F5 73 C0 01 60 00 90 00 1C
    OpenPGP Card V3
</code></pre></div>

<h2>Setting up gpg</h2>
<p><a href="https://gist.github.com/btcdrak/73f7b54eafbed2a3f10f41375a04cb6d">Here is a great write up on how to do it</a></p>
<h2>Setting up PAM</h2>
<p>Install <a href="https://aur.archlinux.org/packages/poldi/">poldi</a>.</p>
<p>We will be using the <code>localdb</code> mode of authentication. Open up <code>/etc/poldi/poldi.conf</code>
your favorite text editor and ensure it is configured like this:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># This is the main configuration file of Poldi.</span>

<span class="c1"># Specify authentication method:</span>
<span class="c1"># (supported methods: localdb, x509)</span>
<span class="n">auth</span><span class="o">-</span><span class="n">method</span> <span class="n">localdb</span>

<span class="c1"># Specify the log file:</span>
<span class="nb">log</span><span class="o">-</span><span class="n">file</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">poldi</span><span class="o">.</span><span class="n">log</span>

<span class="c1"># Enable debugging messages</span>
<span class="n">debug</span>

<span class="c1"># Specify SCDaemon executable</span>
<span class="n">scdaemon</span><span class="o">-</span><span class="n">program</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gnupg</span><span class="o">/</span><span class="n">scdaemon</span>
</code></pre></div>

<p>Then create directory to store the keys:</p>
<div class="codehilite"><pre><span></span><code># mkdir -p /etc/poldi/localdb/keys
</code></pre></div>

<p>Then obtain the serial number of your card:</p>
<div class="codehilite"><pre><span></span><code>$ poldi-ctrl --dump <span class="p">|</span> grep <span class="s2">&quot;Serial number&quot;</span>
</code></pre></div>

<p>Finally store your public key in local database:</p>
<div class="codehilite"><pre><span></span><code># poldi-ctrl --print-key &gt; /etc/poldi/localdb/keys/$YOUR_CARD_SERIAL_NUM
</code></pre></div>

<h3>PAM config files:</h3>
<p>Create file <code>/etc/pam.d/poldi</code> with the following content:</p>
<div class="codehilite"><pre><span></span><code>auth    sufficient    pam_poldi.so
</code></pre></div>

<p>Then, wherever you wish to use your card to authenticate, simply insert:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">auth</span>    <span class="k">include</span>    <span class="nv">pam_poldi</span>.<span class="nv">so</span>
</code></pre></div>

<p>At the top of the corresponding file in <code>/etc/pam.d/</code>. Some programs (like <code>sddm</code>)
do not provide any way to insert a PIN number in order to unlock the card, but
stuff like <code>sudo</code> will prompt you correctly.</p>
</div>
<!-- </py-article> -->
        </div>
    </body>
</html><!-- </py-main> --><!-- </py-index> -->